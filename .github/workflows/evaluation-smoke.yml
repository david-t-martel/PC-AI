name: Evaluation Smoke

on:
  workflow_dispatch:
    inputs:
      dataset:
        description: "Dataset name"
        required: false
        default: "diagnostic"
      max_test_cases:
        description: "Max test cases"
        required: false
        default: "3"
      base_url:
        description: "Mock server base URL"
        required: false
        default: "http://127.0.0.1:9911"

jobs:
  eval-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Mock LLM Server
        shell: pwsh
        run: |
          $port = 9911
          $serverPath = Join-Path $env:RUNNER_TEMP "pcai_eval_mock_server.py"
          @"
import json
from http.server import BaseHTTPRequestHandler, HTTPServer

class Handler(BaseHTTPRequestHandler):
    def _send(self, code, payload):
        body = json.dumps(payload).encode("utf-8")
        self.send_response(code)
        self.send_header("Content-Type", "application/json")
        self.send_header("Content-Length", str(len(body)))
        self.end_headers()
        self.wfile.write(body)

    def do_GET(self):
        if self.path == "/health":
            return self._send(200, {"status": "ready", "backend": "mock"})
        if self.path == "/v1/models":
            return self._send(200, {"data": [{"id": "mock-model"}]})
        return self._send(404, {"error": "not found"})

    def do_POST(self):
        if self.path == "/v1/completions":
            length = int(self.headers.get("Content-Length", "0") or 0)
            if length:
                self.rfile.read(length)
            return self._send(200, {"choices": [{"text": "ok"}]})
        return self._send(404, {"error": "not found"})

if __name__ == "__main__":
    server = HTTPServer(("127.0.0.1", $port), Handler)
    print("mock server ready")
    server.serve_forever()
"@ | Set-Content -Path $serverPath -Encoding UTF8
          $proc = Start-Process -FilePath python -ArgumentList $serverPath -PassThru
          Start-Sleep -Seconds 2
          if ($proc.HasExited) {
            throw "Mock server failed to start."
          }
          $proc.Id | Out-File -FilePath (Join-Path $env:RUNNER_TEMP "pcai_eval_server.pid") -Encoding ascii

      - name: Run Evaluation Smoke
        shell: pwsh
        run: |
          $baseUrl = "${{ inputs.base_url }}"
          $dataset = "${{ inputs.dataset }}"
          $max = [int]"${{ inputs.max_test_cases }}"
          pwsh .\Tests\Evaluation\Invoke-InferenceEvaluation.ps1 `
            -Backend http `
            -BaseUrl $baseUrl `
            -Dataset $dataset `
            -MaxTestCases $max `
            -RunLabel ci-smoke `
            -ProgressMode stream `
            -OutputRoot .\.pcai\evaluation\runs

      - name: Stop Mock Server
        if: always()
        shell: pwsh
        run: |
          $pidFile = Join-Path $env:RUNNER_TEMP "pcai_eval_server.pid"
          if (Test-Path $pidFile) {
            $pid = Get-Content $pidFile | Select-Object -First 1
            Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
          }

      - name: Upload Evaluation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-smoke
          path: .pcai/evaluation/runs/**
          if-no-files-found: warn
