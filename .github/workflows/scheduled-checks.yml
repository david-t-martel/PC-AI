name: Scheduled Checks

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  dependency-check:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check PowerShell Gallery Updates
        shell: pwsh
        run: |
          Write-Host "Checking for module updates on PowerShell Gallery..." -ForegroundColor Cyan

          $modules = @('Pester', 'PSScriptAnalyzer')

          foreach ($module in $modules) {
              try {
                  $installed = Get-Module -ListAvailable -Name $module | Sort-Object Version -Descending | Select-Object -First 1
                  $available = Find-Module -Name $module -ErrorAction Stop

                  if ($installed) {
                      if ($available.Version -gt $installed.Version) {
                          Write-Host "⚠️  $module update available: $($installed.Version) → $($available.Version)" -ForegroundColor Yellow
                      } else {
                          Write-Host "✓ $module is up to date ($($installed.Version))" -ForegroundColor Green
                      }
                  } else {
                      Write-Host "ℹ️  $module not installed (latest: $($available.Version))" -ForegroundColor Cyan
                  }
              } catch {
                  Write-Host "⚠️  Could not check $module: $_" -ForegroundColor Yellow
              }
          }

      - name: Validate All Workflows
        shell: pwsh
        run: |
          Write-Host "Validating GitHub Actions workflows..." -ForegroundColor Cyan

          $workflows = Get-ChildItem -Path .github/workflows -Filter *.yml

          foreach ($workflow in $workflows) {
              Write-Host "`nValidating $($workflow.Name)..." -ForegroundColor Gray

              # Basic YAML validation
              try {
                  $content = Get-Content $workflow.FullName -Raw
                  # Check for common issues
                  if ($content -match 'runs-on:.*\$') {
                      Write-Host "✗ Invalid runs-on syntax in $($workflow.Name)" -ForegroundColor Red
                  } elseif ($content -notmatch 'runs-on:') {
                      Write-Host "✗ Missing runs-on in $($workflow.Name)" -ForegroundColor Red
                  } else {
                      Write-Host "✓ $($workflow.Name) appears valid" -ForegroundColor Green
                  }
              } catch {
                  Write-Host "✗ Error validating $($workflow.Name): $_" -ForegroundColor Red
              }
          }

  link-check:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Documentation Links
        shell: pwsh
        run: |
          Write-Host "Checking links in documentation..." -ForegroundColor Cyan

          $mdFiles = Get-ChildItem -Recurse -Include *.md

          $brokenLinks = @()

          foreach ($file in $mdFiles) {
              $content = Get-Content $file.FullName -Raw
              $links = [regex]::Matches($content, '\[([^\]]+)\]\(([^\)]+)\)')

              foreach ($link in $links) {
                  $url = $link.Groups[2].Value

                  # Check internal file links
                  if ($url -notmatch '^https?://') {
                      $targetPath = Join-Path (Split-Path $file.FullName) $url
                      if (-not (Test-Path $targetPath)) {
                          $brokenLinks += "$($file.Name): Broken link to $url"
                      }
                  }
              }
          }

          if ($brokenLinks) {
              Write-Host "`n⚠️  Broken Links Found:" -ForegroundColor Yellow
              $brokenLinks | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
          } else {
              Write-Host "✓ All internal documentation links valid" -ForegroundColor Green
          }

  health-report:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Repository Health Report
        shell: pwsh
        run: |
          Write-Host "Generating repository health report..." -ForegroundColor Cyan

          $report = @{
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Repository = "${{ github.repository }}"

              Files = @{
                  PowerShell = (Get-ChildItem -Recurse -Include *.ps1,*.psm1,*.psd1).Count
                  Tests = (Get-ChildItem -Path Tests -Recurse -Include *.Tests.ps1 -ErrorAction SilentlyContinue).Count
                  Workflows = (Get-ChildItem -Path .github/workflows -Filter *.yml).Count
                  Documentation = (Get-ChildItem -Recurse -Include *.md).Count
              }

              Modules = @(
                  Get-ChildItem -Path Modules -Directory | ForEach-Object {
                      @{
                          Name = $_.Name
                          HasManifest = Test-Path (Join-Path $_.FullName "$($_.Name).psd1")
                          HasTests = Test-Path (Join-Path "Tests" "$($_.Name).Tests.ps1")
                      }
                  }
              )

              Configuration = @{
                  HasEditorConfig = Test-Path .editorconfig
                  HasGitIgnore = Test-Path .gitignore
                  HasPreCommit = Test-Path .pre-commit-config.yaml
                  HasPSAnalyzerSettings = Test-Path PSScriptAnalyzerSettings.psd1
              }
          }

          $report | ConvertTo-Json -Depth 10 | Out-File -FilePath "health-report.json" -Encoding UTF8

          Write-Host "`n=== Repository Health Report ===" -ForegroundColor Cyan
          Write-Host "PowerShell Files: $($report.Files.PowerShell)" -ForegroundColor Gray
          Write-Host "Test Files: $($report.Files.Tests)" -ForegroundColor Gray
          Write-Host "Workflows: $($report.Files.Workflows)" -ForegroundColor Gray
          Write-Host "Documentation Files: $($report.Files.Documentation)" -ForegroundColor Gray
          Write-Host "`nModules: $($report.Modules.Count)" -ForegroundColor Gray

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.json
          retention-days: 90

  documentation-pipeline:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Documentation Pipeline
        shell: pwsh
        run: |
          Write-Host "Running documentation pipeline..." -ForegroundColor Cyan
          .\Tools\Invoke-DocPipeline.ps1 -Mode Full -SkipRust

      - name: Verify Pipeline Success
        shell: pwsh
        run: |
          $reportPath = "Reports\DOC_PIPELINE_REPORT.json"
          if (Test-Path $reportPath) {
              $report = Get-Content $reportPath -Raw | ConvertFrom-Json
              if ($report.success) {
                  Write-Host "Pipeline completed successfully" -ForegroundColor Green
                  Write-Host "Steps:"
                  foreach ($step in $report.steps) {
                      $symbol = if ($step.Status -eq 'Success') { '✓' } elseif ($step.Status -eq 'Skipped') { '○' } else { '✗' }
                      Write-Host "  $symbol $($step.Name): $($step.Status)"
                  }
              } else {
                  Write-Host "Pipeline completed with errors:" -ForegroundColor Red
                  foreach ($err in $report.errors) {
                      Write-Host "  - $err" -ForegroundColor Red
                  }
                  exit 1
              }
          } else {
              Write-Host "Pipeline report not found" -ForegroundColor Red
              exit 1
          }

      - name: Validate Training Data
        shell: pwsh
        run: |
          $trainingFile = "Deploy\rust-functiongemma-train\data\training_data.jsonl"
          if (Test-Path $trainingFile) {
              $lines = Get-Content $trainingFile
              Write-Host "Training data: $($lines.Count) examples" -ForegroundColor Green

              # Validate first few lines
              $errors = 0
              $lines | Select-Object -First 5 | ForEach-Object {
                  try {
                      $null = $_ | ConvertFrom-Json
                  } catch {
                      $errors++
                  }
              }

              if ($errors -gt 0) {
                  Write-Host "Found $errors JSON parsing errors" -ForegroundColor Yellow
              } else {
                  Write-Host "Training data format valid" -ForegroundColor Green
              }
          } else {
              Write-Host "Training data not generated" -ForegroundColor Yellow
          }

      - name: Upload Documentation Reports
        uses: actions/upload-artifact@v4
        with:
          name: doc-reports-${{ github.run_number }}
          path: |
            Reports/DOC_STATUS.md
            Reports/DOC_PIPELINE_REPORT.json
            Reports/DOC_PIPELINE_REPORT.md
            Reports/API_SIGNATURE_REPORT.json
            Deploy/rust-functiongemma/TOOLS.md
            Deploy/rust-functiongemma-train/data/training_data.jsonl
          retention-days: 30
          if-no-files-found: warn
