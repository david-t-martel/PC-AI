name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

jobs:
  scan:
    runs-on: windows-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check for Hardcoded Credentials
        shell: pwsh
        run: |
          Write-Host "Scanning for hardcoded credentials..." -ForegroundColor Cyan

          $patterns = @(
              'password\s*=\s*["\'][^"\']+["\']',
              'api[_-]?key\s*=\s*["\'][^"\']+["\']',
              'secret\s*=\s*["\'][^"\']+["\']',
              'token\s*=\s*["\'][^"\']+["\']',
              'ConvertTo-SecureString.*-AsPlainText',
              '\$credential\s*=\s*New-Object.*-ArgumentList',
              'PSCredential.*@\(',
              'APIKey\s*=\s*["\'][A-Za-z0-9]{20,}["\']'
          )

          $findings = @()
          Get-ChildItem -Recurse -Include *.ps1,*.psm1,*.psd1 | ForEach-Object {
              $content = Get-Content $_.FullName -Raw
              foreach ($pattern in $patterns) {
                  if ($content -match $pattern) {
                      $findings += "$($_.FullName): Potential credential found matching pattern: $pattern"
                  }
              }
          }

          if ($findings) {
              Write-Host "`n⚠️  Security Issues Found:" -ForegroundColor Red
              $findings | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
              exit 1
          } else {
              Write-Host "✓ No hardcoded credentials found" -ForegroundColor Green
          }

      - name: Check File Permissions
        shell: pwsh
        run: |
          Write-Host "Checking for executable scripts..." -ForegroundColor Cyan

          $scripts = Get-ChildItem -Recurse -Include *.ps1,*.psm1
          Write-Host "✓ Found $($scripts.Count) PowerShell files" -ForegroundColor Green

      - name: Validate Module Manifests
        shell: pwsh
        run: |
          Write-Host "Validating module manifests..." -ForegroundColor Cyan

          $errors = @()
          Get-ChildItem -Path Modules -Recurse -Filter *.psd1 | ForEach-Object {
              try {
                  $manifest = Test-ModuleManifest $_.FullName -ErrorAction Stop
                  Write-Host "✓ $($_.Name) - Valid" -ForegroundColor Green
              } catch {
                  $errors += "$($_.Name): $_"
                  Write-Host "✗ $($_.Name) - Invalid" -ForegroundColor Red
              }
          }

          if ($errors) {
              $errors | ForEach-Object { Write-Error $_ }
              exit 1
          }

      - name: Check for Dangerous Commands
        shell: pwsh
        run: |
          Write-Host "Scanning for dangerous commands..." -ForegroundColor Cyan

          $dangerousCommands = @(
              'Invoke-Expression',
              'iex ',
              'Start-Process.*-Verb RunAs',
              'Remove-Item.*-Recurse.*-Force',
              'Format-Volume',
              'Clear-Disk',
              'Remove-Partition'
          )

          $findings = @()
          Get-ChildItem -Recurse -Include *.ps1,*.psm1 | ForEach-Object {
              $content = Get-Content $_.FullName -Raw
              foreach ($cmd in $dangerousCommands) {
                  if ($content -match $cmd) {
                      # Check if it's in a comment
                      $lines = Get-Content $_.FullName
                      $matchingLines = $lines | Where-Object { $_ -match $cmd -and $_ -notmatch '^\s*#' }
                      if ($matchingLines) {
                          $findings += "$($_.FullName): Contains potentially dangerous command: $cmd"
                      }
                  }
              }
          }

          if ($findings) {
              Write-Host "`n⚠️  Potentially Dangerous Commands Found:" -ForegroundColor Yellow
              $findings | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
              Write-Host "`nReview these commands to ensure they have proper safeguards." -ForegroundColor Yellow
          } else {
              Write-Host "✓ No dangerous commands found" -ForegroundColor Green
          }

      - name: Check Dependencies
        shell: pwsh
        run: |
          Write-Host "Checking module dependencies..." -ForegroundColor Cyan

          Get-ChildItem -Path Modules -Recurse -Filter *.psd1 | ForEach-Object {
              $manifest = Import-PowerShellDataFile $_.FullName
              if ($manifest.RequiredModules) {
                  Write-Host "`n$($_.BaseName) requires:" -ForegroundColor Cyan
                  $manifest.RequiredModules | ForEach-Object {
                      if ($_ -is [hashtable]) {
                          Write-Host "  - $($_.ModuleName) (v$($_.ModuleVersion))" -ForegroundColor Gray
                      } else {
                          Write-Host "  - $_" -ForegroundColor Gray
                      }
                  }
              }
          }

      - name: Generate Security Report
        if: always()
        shell: pwsh
        run: |
          $report = @{
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Repository = "${{ github.repository }}"
              Branch = "${{ github.ref_name }}"
              Commit = "${{ github.sha }}"
              Status = "Completed"
          }

          $report | ConvertTo-Json | Out-File -FilePath "security-report.json" -Encoding UTF8
          Write-Host "`n✓ Security scan completed" -ForegroundColor Green

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json
          retention-days: 30
